<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>校园网上网认证 | 窗外临街</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Python实现上网认证

在学校的同行们应该都知道，目前国内大部分高校的上网采用网络认证系统，这可以简单化不同用户的权限管理，同时对于财务处理方面也有很大的优势。国内类似的系统，例如锐捷，我接触的比较多，通过简单的B/S网页账户登录认证实现上网。这几天，我就尝试使用了抓包工具以及Pyhton的模块做了一个简单的模拟一键登录、一键下线工具。">
<meta property="og:type" content="article">
<meta property="og:title" content="校园网上网认证">
<meta property="og:url" content="http://peihao.space/2016/02/24/Internet_authentication/index.html">
<meta property="og:site_name" content="窗外临街">
<meta property="og:description" content="Python实现上网认证

在学校的同行们应该都知道，目前国内大部分高校的上网采用网络认证系统，这可以简单化不同用户的权限管理，同时对于财务处理方面也有很大的优势。国内类似的系统，例如锐捷，我接触的比较多，通过简单的B/S网页账户登录认证实现上网。这几天，我就尝试使用了抓包工具以及Pyhton的模块做了一个简单的模拟一键登录、一键下线工具。">
<meta property="og:image" content="http://7xowaa.com1.z0.glb.clouddn.com/css.jpg">
<meta property="og:image" content="http://7xowaa.com1.z0.glb.clouddn.com/login.png">
<meta property="og:updated_time" content="2016-02-28T14:22:46.878Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="校园网上网认证">
<meta name="twitter:description" content="Python实现上网认证

在学校的同行们应该都知道，目前国内大部分高校的上网采用网络认证系统，这可以简单化不同用户的权限管理，同时对于财务处理方面也有很大的优势。国内类似的系统，例如锐捷，我接触的比较多，通过简单的B/S网页账户登录认证实现上网。这几天，我就尝试使用了抓包工具以及Pyhton的模块做了一个简单的模拟一键登录、一键下线工具。">
  
    <link rel="alternative" href="/atom.xml" title="窗外临街" type="application/atom+xml">
  

  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?47c906842634689dc55e7f1660f58105";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="baidu_js_push">
	<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</div>
<div class="overlay"> 
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div align="left" style="margin-top:6px;">
<p style="color:#cccc99;font-size:90%">您好，培豪的第<span id="busuanzi_value_site_uv"></span>个小伙伴</p>
</div>
</div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">培豪</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
							<li><a href="/album">相册</a></li>
				        
							<li><a href="/atom.xml">Rss</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/chuangwailinjie" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/chuangwailinjie" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/BeautifulSoup/" style="font-size: 10px;">BeautifulSoup</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/FTP/" style="font-size: 12px;">FTP</a> <a href="/tags/Front-End/" style="font-size: 14px;">Front End</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/JQuery/" style="font-size: 12px;">JQuery</a> <a href="/tags/NoC/" style="font-size: 10px;">NoC</a> <a href="/tags/Numpy/" style="font-size: 10px;">Numpy</a> <a href="/tags/Python/" style="font-size: 18px;">Python</a> <a href="/tags/Requests/" style="font-size: 14px;">Requests</a> <a href="/tags/Router/" style="font-size: 10px;">Router</a> <a href="/tags/Scrapy/" style="font-size: 10px;">Scrapy</a> <a href="/tags/Verilog-HDL/" style="font-size: 16px;">Verilog HDL</a> <a href="/tags/cgi/" style="font-size: 10px;">cgi</a> <a href="/tags/front-end/" style="font-size: 10px;">front end</a> <a href="/tags/hexo优化/" style="font-size: 12px;">hexo优化</a> <a href="/tags/lambda/" style="font-size: 10px;">lambda</a> <a href="/tags/lxml/" style="font-size: 10px;">lxml</a> <a href="/tags/matplotlib/" style="font-size: 10px;">matplotlib</a> <a href="/tags/noc/" style="font-size: 12px;">noc</a> <a href="/tags/pyquery/" style="font-size: 10px;">pyquery</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/re/" style="font-size: 12px;">re</a> <a href="/tags/router/" style="font-size: 14px;">router</a> <a href="/tags/torrent/" style="font-size: 12px;">torrent</a> <a href="/tags/urllib/" style="font-size: 10px;">urllib</a> <a href="/tags/xpath/" style="font-size: 10px;">xpath</a> <a href="/tags/二维码/" style="font-size: 10px;">二维码</a> <a href="/tags/仿真/" style="font-size: 14px;">仿真</a> <a href="/tags/基础知识/" style="font-size: 10px;">基础知识</a> <a href="/tags/实用/" style="font-size: 10px;">实用</a> <a href="/tags/微信/" style="font-size: 10px;">微信</a> <a href="/tags/正则表达式/" style="font-size: 10px;">正则表达式</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a> <a href="/tags/算法/" style="font-size: 10px;">算法</a> <a href="/tags/编码/" style="font-size: 12px;">编码</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/贝叶斯/" style="font-size: 10px;">贝叶斯</a> <a href="/tags/随感/" style="font-size: 12px;">随感</a> <a href="/tags/随笔/" style="font-size: 14px;">随笔</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">衣服晒干风在穿，我一个人，很简单，自己放纵自己管…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">培豪</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="/img/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">培豪</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
					<li><a href="/album">相册</a></li>
		        
					<li><a href="/atom.xml">Rss</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/chuangwailinjie" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/chuangwailinjie" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Internet_authentication" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/24/Internet_authentication/" class="article-date">
  	<time datetime="2016-02-24T04:23:35.000Z" itemprop="datePublished">2016-02-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      校园网上网认证
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Requests/">Requests</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Python/">Python</a>
	</div>



		
		<div class="bookicon"></div>
		<div class="article-hit">
		<span id="busuanzi_container_page_pv">
  Hits <span id="busuanzi_value_page_pv"></span>次</span>
	</div>
	

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
	      	<!-- Table of Contents -->
			
			  <div id="toc" class="toc-article">
			    <strong class="toc-title">文章目录</strong>
			    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Pyhton中流行的相关模块"><span class="toc-number">1.</span> <span class="toc-text">Pyhton中流行的相关模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#urllib"><span class="toc-number">1.1.</span> <span class="toc-text">urllib</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#urllib2"><span class="toc-number">1.2.</span> <span class="toc-text">urllib2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#urllib_and_urllib2_区别"><span class="toc-number">1.3.</span> <span class="toc-text">urllib and urllib2 区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requests"><span class="toc-number">1.4.</span> <span class="toc-text">requests</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#通过Requests模块实现"><span class="toc-number">2.</span> <span class="toc-text">通过Requests模块实现</span></a></li></ol>
			  </div>
			
        <p><img src="http://7xowaa.com1.z0.glb.clouddn.com/css.jpg" alt=""></p>
<p>Python实现上网认证</p>
<hr>
<p>在学校的同行们应该都知道，目前国内大部分高校的上网采用网络认证系统，这可以简单化不同用户的权限管理，同时对于财务处理方面也有很大的优势。国内类似的系统，例如锐捷，我接触的比较多，通过简单的B/S网页账户登录认证实现上网。这几天，我就尝试使用了抓包工具以及Pyhton的模块做了一个简单的模拟一键登录、一键下线工具。    </p>
<a id="more"></a>
<h1 id="Pyhton中流行的相关模块">Pyhton中流行的相关模块</h1><h2 id="urllib">urllib</h2><ol>
<li><p>urlencode不能直接处理unicode对象，所以如果是unicode，需要先编码，有unicode转到utf8，举例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib.urlencode (<span class="string">u'bl'</span>.encode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib       <span class="comment">#sohu 手机主页</span></span><br><span class="line">url = <span class="string">'http://m.sohu.com/?v=3&amp;_once_=000025_v2tov3&amp;_smuid=\ICvXXapq5EfTpQTVq6Tpz'</span></span><br><span class="line">resp = urllib.urlopen(url)</span><br><span class="line">page = resp.read()</span><br><span class="line">f = open(<span class="string">'./urllib_index.html'</span>, <span class="string">'w'</span>)</span><br><span class="line">f.write(page)</span><br><span class="line"><span class="keyword">print</span> dir(resp)</span><br><span class="line"><span class="comment">#结果:</span></span><br><span class="line">[<span class="string">'doc'</span>, <span class="string">'init'</span>, <span class="string">'iter'</span>, <span class="string">'module'</span>, <span class="string">'repr'</span>, <span class="string">'close'</span>, <span class="string">'code'</span>, <span class="string">'fileno'</span>, <span class="string">'fp'</span>, <span class="string">'getcode'</span>, <span class="string">'geturl'</span>, <span class="string">'headers'</span>, <span class="string">'info'</span>, <span class="string">'next'</span>, <span class="string">'read'</span>, <span class="string">'readline'</span>, <span class="string">'readlines'</span>, <span class="string">'url'</span>]</span><br><span class="line"><span class="keyword">print</span> resp.getcode(), resp.geturl(), resp.info(), resp.headers, resp.url</span><br><span class="line"><span class="comment">#resp.url和resp.geturl()结果一样</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编解码示例 urllib.quote和urllib.urlencode都是编码，但用法不一样</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">s = urllib.quote(<span class="string">'This is python'</span>)  <span class="comment">#编码</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'quote:\t'</span>+s    ＃空格用%<span class="number">20</span>替代</span><br><span class="line">s_un = urllib.unquote(s)    ＃解码</span><br><span class="line"><span class="keyword">print</span> <span class="string">'unquote:\t'</span>+s_un</span><br><span class="line">s_plus = urllib.quote_plus(<span class="string">'This is python'</span>)  ＃编码</span><br><span class="line"><span class="keyword">print</span> <span class="string">'quote_plus:\t'</span>+s_plus            ＃空格用＋替代</span><br><span class="line">s_unplus = urllib.unquote_plus(s_plus)       ＃解码</span><br><span class="line"><span class="keyword">print</span> <span class="string">'s_unplus:\t'</span>+s_unplus</span><br><span class="line">s_dict = &#123;<span class="string">'name'</span>: <span class="string">'dkf'</span>, <span class="string">'pass'</span>: <span class="string">'1234'</span>&#125;</span><br><span class="line">s_encode = urllib.urlencode(s_dict)    ＃编码字典转换成url参数 </span><br><span class="line"><span class="keyword">print</span> <span class="string">'s_encode:\t'</span>+s_encode</span><br><span class="line"></span><br><span class="line"><span class="comment">#结果：</span></span><br><span class="line">quote: This%<span class="number">20</span><span class="keyword">is</span>%<span class="number">20</span>python</span><br><span class="line">unquote:   This <span class="keyword">is</span> python</span><br><span class="line">quote_plus:    This+<span class="keyword">is</span>+python</span><br><span class="line">s_unplus:  This <span class="keyword">is</span> python</span><br><span class="line">s_encode:  name=dkf&amp;<span class="keyword">pass</span>=<span class="number">1234</span></span><br></pre></td></tr></table></figure>
<ol>
<li>urlretrieve() urlretrieve多数适用单纯的只下载的功能或者显示下载的进度等</li>
</ol>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">'http://m.sohu.com/?v=3&amp;_once_=000025_v2tov3&amp;_\smuid=ICvXXapq5EfTpQTVq6Tpz'</span></span><br><span class="line">urllib.urlretrieve(url, <span class="string">'./retrieve_index.html'</span>)</span><br><span class="line"></span><br><span class="line">#直接把url链接网页内容下载到retrieve_index.html里了，适用于单纯的下载的功能。</span><br><span class="line">#urllib.urlretrieve(url, local_name, <span class="function"><span class="keyword">method</span>)</span></span><br></pre></td></tr></table></figure>
<h2 id="urllib2">urllib2</h2><ol>
<li><p>urllib2模块定义的函数和类用来获取URL（主要是HTTP的），他提供一些复杂的接口用于处理： 基本认证，重定向，Cookies等。 </p>
</li>
<li><p>常用方法和类 urllib2.urlopen(url[, data][, timeout]) #传url时候，用法同urllib里的urlopen,它打开URL网址，url参数可以是一个字符串url或者是一个Request对象。可选的参数timeout，阻塞操作以秒为单位，如尝试连接（如果没有指定，将使用设置的全局默认timeout值）。实际上这仅适用于HTTP，HTTPS和FTP连接。</p>
</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">'http://m.sohu.com/?v=3&amp;_once_=000025_v2tov3&amp;_\smuid=ICvXXapq5EfTpQTVq6Tpz'</span></span><br><span class="line">resp = urllib2.<span class="function"><span class="title">urlopen</span><span class="params">(url)</span></span></span><br><span class="line">page = resp.<span class="function"><span class="title">read</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>urlopen方法也可通过建立了一个Request对象来明确指明想要获取的url。调用urlopen函数对请求的url返回一个response对象。这个response类似于一个file对象，所以用.read()函数可以操作这个response对象</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">'http://m.sohu.com/?v=3&amp;_once_=000025_v2tov3&amp;_smuid\</span><br><span class="line">=ICvXXapq5EfTpQTVq6Tpz'</span></span><br><span class="line">req = urllib2.<span class="function"><span class="title">Request</span><span class="params">(url)</span></span></span><br><span class="line">resp = urllib2.<span class="function"><span class="title">urlopen</span><span class="params">(req)</span></span></span><br><span class="line">page = resp.<span class="function"><span class="title">read</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>class urllib2.Request(url[, data][, headers][, originreqhost][, unverifiable])  </p>
</li>
</ol>
<p>Request类是一个抽象的URL请求。5个参数的说明如下: </p>
<ul>
<li>URL——是一个字符串，其中包含一个有效的URL。 </li>
<li><p>data——是一个字符串，指定额外的数据发送到服务器，如果没有data需要发送可以为“None”。目前使用data的HTTP请求是唯一的。当请求含有data参数时，HTTP的请求为POST，而不是GET。数据应该是缓存在一个标准的application/x-www-form-urlencoded格式中。urllib.urlencode()函数用映射或2元组，返回一个这种格式的字符串。通俗的说就是如果想向一个URL发送数据（通常这些数据是代表一些CGI脚本或者其他的web应用）。例如在网上填的form（表单）时，浏览器会POST表单的内容，这些数据需要被以标准的格式编码（encode），然后作为一个数据参数传送给Request对象。Encoding是在urlib模块中完成的，而不是在urlib2中完成的。下面是个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">url = <span class="string">'http://www.someserver.com/cgi-bin/register.cgi'</span></span><br><span class="line">values = &#123;<span class="string">'name'</span> : <span class="string">'Michael Foord'</span>,</span><br><span class="line">       <span class="string">'location'</span> : <span class="string">'Northampton'</span>,</span><br><span class="line">       <span class="string">'language'</span> : <span class="string">'Python'</span> &#125;</span><br><span class="line">data = urllib.urlencode(values)      </span><br><span class="line">req = urllib2.Request(url, data)   <span class="comment">#send post</span></span><br><span class="line">response = urllib2.urlopen(req)</span><br><span class="line">page = response.read()</span><br></pre></td></tr></table></figure>
</li>
<li><p>headers——是字典类型，头字典可以作为参数在request时直接传入，也可以把每个键和值作为参数调用add_header()方法来添加。作为辨别浏览器身份的User-Agent header是经常被用来恶搞和伪装的，因为一些HTTP服务只允许某些请求来自常见的浏览器而不是脚本，或是针对不同的浏览器返回不同的版本。例如，Mozilla Firefox浏览器被识别为“Mozilla/5.0 (X11; U; Linux i686) Gecko/20071127 Firefox/2.0.0.11”。默认情况下，urlib2把自己识别为Python-urllib/x.y（这里的xy是python发行版的主要或次要的版本号，如在Python 2.6中，urllib2的默认用户代理字符串是“Python-urllib/2.6。下面的例子和上面的区别就是在请求时加了一个headers，模仿IE浏览器提交请求。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">url = <span class="string">'http://www.someserver.com/cgi-bin/register.cgi'</span></span><br><span class="line">user_agent = <span class="string">'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'</span></span><br><span class="line">values = &#123;<span class="string">'name'</span> : <span class="string">'Michael Foord'</span>,</span><br><span class="line">        <span class="string">'location'</span> : <span class="string">'Northampton'</span>,</span><br><span class="line">        <span class="string">'language'</span> : <span class="string">'Python'</span> &#125;</span><br><span class="line">headers = &#123; <span class="string">'User-Agent'</span> : user_agent &#125;</span><br><span class="line">data = urllib.urlencode(values)</span><br><span class="line">req = urllib2.Request(url, data, headers)</span><br><span class="line">response = urllib2.urlopen(req)</span><br><span class="line">the_page = response.read()</span><br></pre></td></tr></table></figure>
<p>标准的headers组成是(Content-Length, Content-Type and Host)，只有在Request对象调用urlopen()（上面的例子也属于这个情况）或者OpenerDirector.open()时加入。两种情况的例子如下： 使用headers参数构造Request对象，如上例在生成Request对象时已经初始化header，而下例是Request对象调用add_header(key, val)方法附加header（Request对象的方法下面再介绍）：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import urllib2</span><br><span class="line">req = urllib2.<span class="function"><span class="title">Request</span><span class="params">(<span class="string">'http://www.example.com/'</span>)</span></span></span><br><span class="line">req.<span class="function"><span class="title">add_header</span><span class="params">(<span class="string">'Referer'</span>, <span class="string">'http://www.python.org/'</span>)</span></span>    </span><br><span class="line">#http是无状态的协议，上一次客户端的请求与下一次客户端到服务器的请求无关系的，多数省略这一步</span><br><span class="line">r = urllib2.<span class="function"><span class="title">urlopen</span><span class="params">(req)</span></span></span><br></pre></td></tr></table></figure>
<p>OpenerDirector为每一个Request自动加上一个User-Agent header，所以第二种方法如下（urllib2.buildopener会返回一个OpenerDirector对象，关于urllib2.buildopener类下面再说）：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import urllib2</span><br><span class="line">opener = urllib2.<span class="function"><span class="title">build_opener</span><span class="params">()</span></span></span><br><span class="line">opener<span class="class">.addheaders</span> = [(<span class="string">'User-agent'</span>, <span class="string">'Mozilla/5.0'</span>)]</span><br><span class="line">opener.<span class="function"><span class="title">open</span><span class="params">(<span class="string">'http://www.example.com/'</span>)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>urllib2.installopener(opener)和urllib2.buildopener([handler, …])　</strong>  </p>
<p>installopener和buildopener这两个方法通常都是在一起用,也有时候buildopener单独使用来得到OpenerDirector对象。<br>installopener实例化会得到OpenerDirector 对象用来赋予全局变量opener。如果想用这个opener来调用urlopen，那么就必须实例化得到OpenerDirector；这样就可以简单的调用OpenerDirector.open()来代替urlopen()。<br>build_opener实例化也会得到OpenerDirector对象，其中参数handlers可以被BaseHandler或他的子类实例化。子类中可以通过以下实例化：ProxyHandler (如果检测代理设置用)扫描代理会用到，很重要这个, UnknownHandler, HTTPHandler, HTTPDefaultErrorHandler, HTTPRedirectHandler, FTPHandler, FileHandler, HTTPErrorProcessor。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import urllib2</span><br><span class="line">req = urllib2.<span class="function"><span class="title">Request</span><span class="params">(<span class="string">'http://www.python.org/'</span>)</span></span></span><br><span class="line">opener=urllib2.<span class="function"><span class="title">build_opener</span><span class="params">()</span></span></span><br><span class="line">urllib2.<span class="function"><span class="title">install_opener</span><span class="params">(opener)</span></span></span><br><span class="line">f = opener.<span class="function"><span class="title">open</span><span class="params">(req)</span></span></span><br></pre></td></tr></table></figure>
<p>如上使用 urllib2.install_opener()设置 urllib2 的全局 opener。这样后面的使用会很方便，但不能做更细粒度的控制，比如想在程序中使用两个不同的 Proxy 设置等。比较好的做法是不使用 install_opener 去更改全局的设置，而只是直接调用 opener的open 方法代替全局的 urlopen 方法。</p>
<p>说到这Opener和Handler之间的操作听起来有点晕。整理下思路就清楚了。    </p>
<p>当获取一个URL时，可以使用一 个opener（一个urllib2.OpenerDirector实例对象，可以由build_opener实例化生成）。正常情况下程序一直通过urlopen使用默认的opener（也就是说当你使用urlopen方法时，是在隐式的使用默认的opener 对象），但也可以创建自定义的openers（通过操作 器handlers创建的opener实例）。所有的重活和麻烦都交给这些handlers来做。    </p>
<p>每一个handler知道如何以一种特定的协议（http，ftp等等）打开url，或者如何处理打开url发生的HTTP重定向，或者包含的HTTP cookie。创建openers时如果想要安装特别的handlers来实现获取url（如获取一个处理cookie的opener，或者一个不处理重定向的opener）的话，先实例一个OpenerDirector对象，然后多次调用.add_handler(some_handler_instance)来创建一个opener。或者，你可以用build_opener，这是一个很方便的创建opener对象的函数，它只有一个函数调用 。build_opener默认会加入许多handlers，它提供了一个快速的方法添加更多东西和使默认的handler 失效。</p>
<p>install_opener如上所述也能用于创建一个opener对象，但是这个对象是（全局）默认的opener。这意味着调用urlopen将会用到你刚创建的opener。也就是说上面的代码可以等同于下面这段。这段代码最终还是使用的默认opener。一般情况下我们用build_opener为的是生成自定义opener，没有必要调用install_opener，除非是为了方便。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import urllib2</span><br><span class="line">req = urllib2.<span class="function"><span class="title">Request</span><span class="params">(<span class="string">'http://www.python.org/'</span>)</span></span></span><br><span class="line">opener=urllib2.<span class="function"><span class="title">build_opener</span><span class="params">()</span></span>       ＃ 创建opener对象</span><br><span class="line">urllib2.<span class="function"><span class="title">install_opener</span><span class="params">(opener)</span></span>      ＃定义全局默认opener</span><br><span class="line">f = urllib2.<span class="function"><span class="title">urlopen</span><span class="params">(req)</span></span>          #urlopen使用默认opener，但是install_opener</span><br><span class="line">#已经把opener设为全局默认了，这里便是使用上面的建立的opener</span><br></pre></td></tr></table></figure>
<ol>
<li>如果只是单纯的下载或者显示下载进度，不对下载后的内容做处理等，比如下载图片，css，js文件等，可以用urlilb.urlretrieve（）</li>
<li>如果是下载的请求需要填写表单，输入账号，密码等，建议用urllib2.urlopen(urllib2.Request())</li>
<li>在对字典数据编码时候，用到的是urllib.urlencode()</li>
</ol>
<h2 id="urllib_and_urllib2_区别">urllib and urllib2 区别</h2><p>urllib和urllib2模块都做与请求URL相关的操作，但他们提供不同的功能。  </p>
<p>urllib2.urlopen accepts an instance of the Request class or a url, （where as urllib.urlopen only accepts a url 中文意思就是：urllib2.urlopen可以接受一个Request对象或url在接受Request对象时候，并以此可以来设置一个URL的headers</p>
<p>urllib.urlopen只接收一个url    </p>
<p>urllib 有urlencode,urllib2没有，这也是为什么总是urllib，urllib2常会一起使用的原因</p>
<h2 id="requests">requests</h2><ol>
<li><p>Requests 使用的是 urllib3，继承了urllib2的所有特性。Requests支持HTTP连接保持和连接池，支持使用cookie保持会话，支持文件上传，支持自动确定响应内容的编码，支持国际化的 URL 和 POST 数据自动编码。 </p>
</li>
<li><p>举例：</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">resp = requests.get(<span class="string">'http://www.mywebsite.com/user'</span>)</span><br><span class="line">userdata = &#123;<span class="string">"firstname"</span>: <span class="string">"John"</span>, <span class="string">"lastname"</span>: <span class="string">"Doe"</span>, <span class="string">"password"</span>: <span class="string">"jdoe123"</span>&#125;</span><br><span class="line">resp = requests.post(<span class="string">'http://www.mywebsite.com/user'</span>, params=userdata)</span><br><span class="line">resp = requests.put(<span class="string">'http://www.mywebsite.com/user/put'</span>)</span><br><span class="line">resp = requests.delete(<span class="string">'http://www.mywebsite.com/user/delete'</span>)</span><br><span class="line">resp.json()   <span class="comment"># 假如返回的是json数据</span></span><br><span class="line">resp.text     <span class="comment">#返回的不是text数据</span></span><br><span class="line">resp.headers[<span class="string">'content-type'</span>]  <span class="comment">#返回text/html;charset=utf-8</span></span><br><span class="line">f = open(<span class="string">'request_index.html'</span>, <span class="string">'w'</span>)</span><br><span class="line">f.write(page.encode(<span class="string">'utf8'</span>))          </span><br><span class="line"><span class="comment">#test 发现requests抓下来的页面必须要编码\</span></span><br><span class="line"><span class="comment">#写入,（抓下来的是unicode），urllib和urllib2抓下来可以直接写入，</span></span><br><span class="line"><span class="comment">#因为这两者抓下来的page是str</span></span><br></pre></td></tr></table></figure>
<ol>
<li>其他功能特性</li>
</ol>
<ul>
<li>国际化域名和 URLs</li>
<li>Keep-Alive &amp; 连接池</li>
<li>持久的 Cookie 会话</li>
<li>类浏览器式的 SSL 加密认证 </li>
<li>基本/摘要式的身份认证</li>
<li>优雅的键/值 Cookies</li>
<li>自动解压</li>
<li>Unicode 编码的响应体</li>
<li>多段文件上传</li>
<li>连接超时</li>
<li>支持 .netrc</li>
<li>适用于 Python 2.6—3.4</li>
<li>线程安全</li>
</ul>
<ol>
<li><p>requests不是python自带的库，需要另外安装 easy_install or pip install</p>
</li>
<li><p>requests缺陷:直接使用不能异步调用，速度慢（from others）。官方的urllib可以替代它。</p>
</li>
</ol>
<h1 id="通过Requests模块实现">通过Requests模块实现</h1><p>最开始我尝试使用的是urllib模块，通过抓包工具获取上网认证的流程。一般正常的使用情况是，我们通过Browser的Get方式，获取服务器的Response，拿到登录界面，然后通过账户、密码的填写，表格POST传递给相应的action处理，然后在获取Response获取认证成功数据。我在做完了这一个工作之后，简化了第一步，直接构造传递表格信息，简化流程，提高运行速度。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST http://<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/eportal/userV2.do?method=login&amp;param=true&amp;wlanuserip=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>&amp;wlanacname=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>&amp;nasip=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>&amp;mac=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>&amp;t=wirelessv2&amp;url=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>&amp;username=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>&amp;pwd=<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> HTTP/1.1</span><br><span class="line">Host: 172.18.6.30</span><br><span class="line">User-Agent: </span><br><span class="line">Content-Length: 67</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: <span class="keyword">*</span>/<span class="keyword">*</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Connection: closed</span><br></pre></td></tr></table></figure>
<p>通过urllib模块，我没能够将Connection这一状态保持，正常通过浏览器登录，在传递之后，肯定是保持连接存活的，但是通过Python的urllib模块，由于在模块的函数AbstractHTTPHandler.do_open()中已经固化了Connection为closed，所以很难改变。keep-alive 是http persistent connection，urllib 没有实现这个特性，所以不允许 keep-alive。试验后，上网认证必须保持keep-alive，否则的话就会提示没有这个设备，不能认证成功。    </p>
<p>我查阅了相关资料，有几种解决方案：</p>
<ul>
<li><p>httplib</p>
</li>
<li><p>urlgrabber</p>
</li>
<li><p>Requests</p>
</li>
</ul>
<p>最后我就尝试使用了Requests模块，相当的简单方便。学校在认证信息传递过程的POST操作过程中，并没有将先关信息加密处理，省去了我的很多工作。</p>
<pre><code class="python">postData = {<span class="string">'username'</span> : <span class="string">'***'</span>,
            <span class="string">'usernameHidden'</span>:<span class="string">''</span>,
            <span class="string">'authorMode'</span>:<span class="string">''</span>,
            <span class="string">'pwd'</span> : <span class="string">'***'</span>}<span class="comment">#自己填充</span>


<span class="comment">#构造header，一般header至少要包含一下两项。这两项是从抓到的包里分析得出的。</span>
headers = {<span class="string">'User-Agent'</span> : <span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 UBrowser/5.5.10106.5 Safari/537.36'</span>,
           <span class="string">'Referer'</span> : <span class="string">'http://172.18.6.30/'</span>,
           <span class="string">'Connection'</span>:<span class="string">'keep-alive'</span>,
           <span class="string">'Accept'</span>:<span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,
           <span class="string">'Accept-Encoding'</span>:<span class="string">'gzip, deflate'</span>}

posturl=<span class="string">'http://172.18.6.30/eportal/userV2.do?method=login&amp;param=true&amp;wlanuserip=4a74b7a4b9aa0b72c9f20758e1b35282&amp;wlanacname=353477f414861cdd&amp;ssid=15e792de8d103cfd&amp;nasip=704b71fc82aa0c88911e9f71944eba43&amp;mac=aad9ba78888755209ff8e82016aa5765&amp;t=wireless-v2&amp;url=f58cd7a67bbfecbcf3027f3e4bf7b3807231ca007bf7eab9a0a21ad866eb54c0ca6c6fc25773bb30&amp;username=***&amp;pwd=***'</span>
<span class="comment">#上面的url是通过抓包获得</span>
</code></pre>
<p>然后做了一个简单的UI，打包成win平台可执行程序</p>
<p><img src="http://7xowaa.com1.z0.glb.clouddn.com/login.png" alt=""></p>

      
      
	<! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &weierp;&weierp;&weierp;<br>
		   得到的是侥幸，失去的是人生
        </span>
        <br>
      </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<!-- 支付宝打赏图案 -->
		<img src="/img/zhifubao.jpg" alt="支付宝打赏"> 
		<!-- 微信打赏图案 -->
		<img src="/img/wx.jpg" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
<! -- 添加捐赠图标 -->


	
			<! -- 添加版权信息 -->
<div class="article-footer-copyright">
<center>本文由<b><a href="/index.html" target="_blank" title="培豪">培豪</a></b>创作和发表,采用<b>BY</b>-<b>NC</b>-<b>SA</b>国际许可协议进行许可</center>

<center>转载请注明作者及出处,本文作者为<b><a href="/index.html" target="_blank" title="培豪">培豪</a></b>,本文标题为<b><a href="/2016/02/24/Internet_authentication/" target="_blank" title="校园网上网认证">校园网上网认证</a></b></center>

<center>本文链接为<b><a href="/2016/02/24/Internet_authentication/" target="_blank" title="校园网上网认证">http://peihao.space/2016/02/24/Internet_authentication/</a></b>.</center>
</div>
<! -- 添加版权信息 -->
		
    </div>
    
  </div>

  
    
<nav id="article-nav">
  
    <a href="/2016/02/25/片上网络/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          片上网络
        
      </div>
    </a>
  
  
    <a href="/2016/02/03/csdn_viewer/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">CSDN访问量作弊器</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
  
		
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Internet_authentication" data-title="校园网上网认证" data-url="http://peihao.space/2016/02/24/Internet_authentication/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"chuangwailinjie"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 培豪
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<div id="totop" style="position:fixed;bottom:100px;right:30px;cursor: pointer;">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>
<script src="/js/totop.js"></script>

  </div>
</body>
</html>